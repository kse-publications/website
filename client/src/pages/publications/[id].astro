---
import '@/styles/globals.css'
import { DEFAULT_PAGE } from '@/config/search-params'
import type { PaginatedCollection } from '@/types/common/paginated-collection'
import type { PublicationSummary } from '@/types/publication-summary/publication-summary'

import { getPublication } from '@/services/search/get-publications'
import PublicationPage from '@/components/publications/publication-section'
import { getRelatedByAuthors } from '../../services/search/get-publications'
import Layout from '@/layouts/Layout.astro'

const { id } = Astro.params as { id: string }
let relatedPublications: PaginatedCollection<PublicationSummary>

const clientUuid = Astro.cookies.get('client-uuid')

const data = await getPublication(id, clientUuid?.value).catch((error) => {
  console.log(error)
})

const authorsIds = data.authors.map((author: any) => author.id)

const fetchRelatedPublications = async () => {
  let publications = await getRelatedByAuthors(data.id, DEFAULT_PAGE, authorsIds.join('-'))
  return publications
}

relatedPublications = await fetchRelatedPublications()
---

<Layout title=`KSE Publications | ${data.title}`>
  <PublicationPage
    data={data}
    relatedPublications={relatedPublications}
    transition:persist
    client:load
  />
</Layout>
