---
import '@/styles/globals.css'
import Layout from '../layouts/Layout.astro'
import SearchSection from '@/components/search-results/search-section'
import { getInitialPublications, searchPublications } from '../services/search/get-publications'
import type { PaginatedCollection } from '@/types/common/paginated-collection'
import type { PublicationSummary } from '@/types/publication-summary/publication-summary'
import { DEFAULT_PAGE } from '@/config/search-params'
import { getFilters } from '@/services/filters/filters'

const filters = await getFilters()

let initialPublications: PaginatedCollection<PublicationSummary>
const searchParams = Astro.url.searchParams

const searchText = searchParams.get('searchText')
const selectedFilters =
  searchParams
    .get('filters')
    ?.split(',')
    .map((filter) => parseInt(filter, 10)) || []

const isRecent = !searchText && !selectedFilters.length

if (!searchText) {
  initialPublications = await getInitialPublications({
    page: DEFAULT_PAGE,
    filters: selectedFilters,
  })
} else {
  const searchData = {
    searchText: searchText || '',
    page: DEFAULT_PAGE,
    filter: selectedFilters,
  }
  initialPublications = await searchPublications(searchData)
}
---

<Layout title="KSE docs | Search">
  <SearchSection
    filters={filters}
    initialPublications={initialPublications}
    isRecent={isRecent}
    client:load
  />
</Layout>
